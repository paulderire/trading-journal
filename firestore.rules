rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if new doc has correct userId
    function hasValidUserId() {
      return request.resource.data.userId == request.auth.uid;
    }
    
    // Helper to check ownership for single doc reads/updates/deletes
    function isOwner() {
      return resource.data.userId == request.auth.uid;
    }
    
    // Trades collection
    match /trades/{tradeId} {
      // Allow list queries when authenticated (query must filter by userId client-side)
      allow list: if isAuthenticated();
      // Allow get single doc only if owner
      allow get: if isAuthenticated() && isOwner();
      allow create: if isAuthenticated() && hasValidUserId();
      allow update, delete: if isAuthenticated() && isOwner();
    }
    
    // Missed trades collection
    match /missed_trades/{tradeId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated() && isOwner();
      allow create: if isAuthenticated() && hasValidUserId();
      allow update, delete: if isAuthenticated() && isOwner();
    }
    
    // Goals collection
    match /goals/{goalId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated() && isOwner();
      allow create: if isAuthenticated() && hasValidUserId();
      allow update, delete: if isAuthenticated() && isOwner();
    }
    
    // Habits collection
    match /habits/{habitId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated() && isOwner();
      allow create: if isAuthenticated() && hasValidUserId();
      allow update, delete: if isAuthenticated() && isOwner();
    }
    
    // Habit completions collection
    match /habit_completions/{completionId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated() && isOwner();
      allow create: if isAuthenticated() && hasValidUserId();
      allow update, delete: if isAuthenticated() && isOwner();
    }
    
    // Daily tasks collection
    match /daily_tasks/{taskId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated() && isOwner();
      allow create: if isAuthenticated() && hasValidUserId();
      allow update, delete: if isAuthenticated() && isOwner();
    }
    
    // Daily notes collection
    match /daily_notes/{noteId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated() && isOwner();
      allow create: if isAuthenticated() && hasValidUserId();
      allow update, delete: if isAuthenticated() && isOwner();
    }
    
    // Psychology notes collection
    match /psychology_notes/{noteId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated() && isOwner();
      allow create: if isAuthenticated() && hasValidUserId();
      allow update, delete: if isAuthenticated() && isOwner();
    }
    
    // Backtesting strategies collection
    match /strategies/{strategyId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated() && isOwner();
      allow create: if isAuthenticated() && hasValidUserId();
      allow update, delete: if isAuthenticated() && isOwner();
    }
    
    // User profiles collection
    match /user_profiles/{profileId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated() && isOwner();
      allow create: if isAuthenticated() && hasValidUserId();
      allow update, delete: if isAuthenticated() && isOwner();
    }
    
    // Trading accounts collection
    match /accounts/{accountId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated() && isOwner();
      allow create: if isAuthenticated() && hasValidUserId();
      allow update, delete: if isAuthenticated() && isOwner();
    }
    
    // Alternative trading_accounts collection
    match /trading_accounts/{accountId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated() && isOwner();
      allow create: if isAuthenticated() && hasValidUserId();
      allow update, delete: if isAuthenticated() && isOwner();
    }
    
    // Trade plans collection
    match /trade_plans/{planId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated() && isOwner();
      allow create: if isAuthenticated() && hasValidUserId();
      allow update, delete: if isAuthenticated() && isOwner();
    }
    
    // Financial goals collection
    match /financial_goals/{goalId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated() && isOwner();
      allow create: if isAuthenticated() && hasValidUserId();
      allow update, delete: if isAuthenticated() && isOwner();
    }
    
    // Tags collection
    match /tags/{tagId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated() && isOwner();
      allow create: if isAuthenticated() && hasValidUserId();
      allow update, delete: if isAuthenticated() && isOwner();
    }
    
    // User profiles/settings
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
